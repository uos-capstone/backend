version: "3.8"

# 공통 설정을 앵커로 분리
x-spring-common: &spring-common
  build:
    context: .
    dockerfile: Dockerfile
  image: my-spring-app:latest
  depends_on:
    - redis
  environment:
    PROFILE: dev
    # PostgreSQL
    SPRING_DATASOURCE_URL:      jdbc:postgresql://host.docker.internal:5432/brainoverflow
    SPRING_DATASOURCE_USERNAME: postgres
    SPRING_DATASOURCE_PASSWORD: postgres
    # Redis
    REDIS_HOST: redis
    REDIS_PORT: 6379
    # RabbitMQ
    SPRING_RABBITMQ_HOST:       host.docker.internal
    SPRING_RABBITMQ_PORT:       5672

services:
  redis:
    image: redis:7
    container_name: redis
    ports:
      - "6379:6379"

  spring-1:
    <<: *spring-common
    ports:
      - "8080:8080"

  spring-2:
    <<: *spring-common
    ports:
      - "8081:8080"

  spring-3:
    <<: *spring-common
    ports:
      - "8082:8080"
